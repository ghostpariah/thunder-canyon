<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Contacts 2</title>
    <link rel="stylesheet" type="text/css" href="../css/contacts.css"/>
    
    <script>if (typeof module === 'object') {window.module = module; module = undefined;}</script>
	
    <script src="../scripts/jquery-1.11.3.min.js"></script>
    <script src="../scripts/jquery-ui-1.11.4.custom/jquery-ui.min.js"></script>
    
	<script>if (window.module) module = window.module;</script>
</head>
<body>
    <div id='contactsHeader'>
        
    </div>
    
    <span class="visibleInput" id="customerNameWrapper">
                    
                    <label>Customer Name:&nbsp;</label>
                    
                    <input id="txtCustomerName" tabindex="1" list="lstCustomer" onfocus="fillCustomerDataList()" type="text" style="z-index:20000;"/>
                    
                    <datalist id="lstCustomer" class="classic">
                        
                      </datalist>
                </span>
    
        <div id="results"></div>
    <div id = 'contactsMain'>
        
        <div id='currentContacts'>
            <ul id='l'></ul>

        </div>
        <!-- end-->
        <form> 
             
            <div class = 'inline-input-group'>
                <div class = 'input-block'>
                    <label>Company Name</label><br>
                    <input id="txtCompanyName" class="classic">
                </div>           
            </div>        
            <div class = 'inline-input-group'>
                <div class = 'input-block'>
                    <label>First Name</label><br>
                    <input id="txtFirstName">
                </div>
                <div class = 'input-block'>
                    <label>Last Name</label><br>
                    <input id="txtLastName" type="text">
                </div>
            </div>
            <div class = 'inline-input-group'>
                <div class = 'input-block'>
                    <label>Phone Number</label><br>
                    <input id="txtPhoneNumber1" type="text">
                </div> 

            </div>
            <div class = 'inline-input-group'>
                <div class = 'input-block'>
                    <label>Email</label><br>
                    <input id="txtEmail" type="text">
                </div>           
            </div>
            <div class = 'inline-input-group'>
                <div class = 'input-block'>
                    
                    <input id="btnSubmit" type="button" value="add contact" onclick = "add()">

                </div>           
            </div>
        </form>
    </div>
<script>
const conElectron = require('electron');
const conIPC = conElectron.ipcRenderer
const path = require('path')
const url = require('url')
const header = document.getElementById('contactsHeader')
const inpCompany = document.getElementById('txtCompanyName')
const inpFirstname = document.getElementById('txtFirstName')
const inpLastname = document.getElementById('txtLastName')
const inpPhoneNumber = document.getElementById('txtPhoneNumber1')
const inpEmail = document.getElementById('txtEmail')
const dataList = document.getElementById('lstCustomers')
const contactContent = document.getElementById('l')
const dt = new Date()
let companyIsNew = false
let contactExists = false
let conID 
let val
var test
let isBackspace
let isShift
let keyPressed
let notNumeric
let allowChar = false
let contactMethodIndex
let addCN 
let addFN 
let addLN 
let addCID 
let addPN 
let addEm
let addCM
/*******
********
*function to format phone number on add contact page
********
*******/
function formatPN(inp){


$(inp).on({
		
		'keydown': function (event) {
            val = this.value;
            notNumeric = (isNaN(event.key))? 	true:false;
            isBackspace = (event.keyCode == 8)?true:false;
            isShift = (event.keyCode == 16)?true:false;            
            keyPressed = event.key		
         },
        /*
        * the keypress event if needed in the future fires in this order
        */
        //  'keypress' : function(event){
		//     
        //     
        // },
        'input' : function(event){
		    val = this.value;
            
            if(notNumeric){
                switch(keyPressed){
                    case "Shift":
                        //console.log("shift key")
                        break;
                    case "(": 
                        (val.length == 1)?allowChar=true:this.value = this.value.substring(0,this.value.length-1);                        
                        break;
                    case ")":
                        (val.length == 5)?allowChar=true:this.value = this.value.substring(0,this.value.length-1);
                        break;
                    case "Backspace":
                        
                        break;
                    case "-": 
                        (val.length == 9)?allowChar=true:this.value = this.value.substring(0,this.value.length-1);
                    break;
                    default:
                        if(!isBackspace && !isShift){
                        
                       // }else if(isShift){
                            
                        //}else{
                            this.value = this.value.substring(0,this.value.length-1)
                        }
                        break;
                }

            }
        },
		'keyup': function(event){
			val = this.value;		
            //console.log("keyup "+val.length)
            var regexObj = /^\(?([0-9]{3})\)?[-. ]?([0-9]{3})[-. ]?([0-9]{4})$/;
            if(event.keyCode ==8){
                //console.log(val.length)
                switch(val.length){
                    case 5:
                        this.value = this.value.substr(1,2);
                    break;
                    case 6:
                        this.value = this.value.substr(1,3);
                    break;
                    case 9:
                        this.value = this.value.substr(0,8);
                    break;
                    case 10:
                        this.value = this.value.substr(0,9);
                    break;
                    case 19: 
                        this.value = this.value.substr(0,14);
                    break;
                    default:
                    break;
                }
            }
            if(allowChar && event.keyCode != 8){
                switch(val.length){
                    case 4: 
                        this.value = val+") ";
                    break;
                    case 9: 
                        this.value = val+"-";
                    break;
                    case 15: 
                        let lastDigit = this.value.substr(14,1);
                        this.value = this.value.substr(0,14) + " ext:" + lastDigit;
                    break;
                    default:
                    console.log(val)
                    break;
                    
                }
                

            }else{
                if(!allowChar && event.keyCode != 8){
                    switch(val.length){
                    case 3: 
                        this.value = "("+val+") ";
                        //console.log("keyup add parenthesis when allowChar false")
                    break;
                    case 4:
                        this.value = "("+this.value.substr(0,3)+") " + this.value.substr(3,1);
                    break;
                    case 5:
                        this.value = this.value.substr(1,3);
                    break;
                    case 9: 
                        this.value = val+"-";
                    break;
                    case 10:
                        this.value = this.value.substr(0,9)+"-" + this.value.substr(9,1);
                    break;
                    case 15: 
                        let lastDigit = this.value.substr(14,1);
                        this.value = this.value.substr(0,14) + " ext:" + lastDigit;
                    break;
                    default:
                        console.log(val)
                    break;
                    
                    }
                    
                }
            }
            

			
		},        
		"blur": function(){
			
		}
	});
}

conIPC.on('name-chosen', (event, args1, args2, args3, args4, args5, args6)=>{
    //alert(args6+" "+args5)
        //company name
        if(args1){
            inpCompany.value = args1
            addCN = args1
        }

        // boolean telling if new
        if(args2){
            companyIsNew = args2            
        }

        // contact first name
        if(args3){
            inpFirstname.value = args3
            addFN = args3
            contactExists = true
        }

        // contact last name
        if(args4){
            inpLastname.value = args4
            addLN = args4
        }

        // contactID
        if(args5){
            //  @desc contactID
            //  
            console.log('args5 contactID passed from main'+args5)
            conID = args5
            addCID = args5
            //alert(args5)
        }

        //index of selected item
        if(args6){
            addCM = args6
            contactMethodIndex = args6
        }
    
        
        
    })
   
setTimeout(()=>{
    loadContactsPage()
    
},200)
function loadContactsPage(){
    let mainHeadText = document.createTextNode(`${inpCompany.value} CONTACTS`)
    let mainHead = document.createElement('H2')
    mainHead.appendChild(mainHeadText)
    header.appendChild(mainHead)
    //fillCustomersDataList()
    //alert(inpCompany.value)
    pullContacts(inpCompany.value)
    inpCompany.addEventListener('change', ()=>{
        //alert('change triggered')
        let cn = inpCompany.value
        if(cn!="" || cn!=undefined){
            pullContacts(cn)
        }else{alert("hello")}
    })
    

}

function add(conMethod){
    let total=0
    const editData = new Object()
    //alert(contactMethodIndex);
    let inpDynamic = document.getElementById("inp"+conID)
    let arrContact = conIPC.sendSync('get-contact',addCID, addCN)
    total = arrContact.phoneNumbers.length + arrContact.emails.length -1
    alert(arrContact.phoneNumbers.length)
    //  send fields that are updated to main
    editData.id = conIPC.sendSync('get-company-id',addCN) 
    
    /*     
    if(inpCompany.value != ""){
    editData.companyName = inpCompany.value  
    } 
    if(inpFirstname.value != ""){
    editData.firstname = inpFirstname.value  
    } 
    if(inpLastname.value != ""){
    editData.lastname = inpLastname.value  
    } 
    if(inpDynamic.value != ""){
        alert(document.getElementById("inp"+conID).value)
    editData.phoneNumber = document.getElementById("inp"+conID).value  
    } 
    if(inpEmail.value != ""){
    editData.email = inpEmail.value  
    } 
    */
    if(inpDynamic.value != ""){
        switch(conMethod){
                case "phone":
                    editData.phoneNumber = inpDynamic.value
                    editData.position = arrContact.phoneNumbers.length +1
                break;
                case "email":
                    editData.email = inpDynamic.value
                    editData.position = arrContact.phoneNumbers.length + arrContact.emails.length +3
                    break;
                default:
                    break;
        }
    }
    // if(inpDynamic.value != ""){
    //     //alert(document.getElementById("inp"+conID).value)
    // editData.phoneNumber = document.getElementById("inp"+conID).value  
    // }       
    if(!contactExists){ 
        editData.contactID = dt.getTime()
        conIPC.send('add-contact', inpCompany.value, editData, companyIsNew) 
    }else{ 
        editData.contactID = conID      
        conIPC.send('edit-contact', editData, conID)

    }
    //alert(editData.id+"</br>"+editData.contactID)
}
function pullContacts(comp){
    if(comp){
    let cont = conIPC.sendSync('get-contacts',comp)
    //console.log(cont)
   fillContacts(cont)
    }
}

function createInput(contactToAddTo, conMethod){
    let AddPhoneFieldList = document.createElement("li")
    let inpA = document.createElement("input")
    let addButton = document.createElement("div")
    let ab = document.createTextNode("add")
    addButton.appendChild(ab)
    addButton.setAttribute("class", "contactButton")
    addButton.addEventListener("click", ()=>{
        add(conMethod)
    })
    let cancelButton = document.createElement("div")    
    let cb = document.createTextNode("cancel")    
    cancelButton.appendChild(cb)
    cancelButton.setAttribute("class", "contactButton")
    cancelButton.addEventListener("click",()=>{
        window.close()
    })
    inpA.setAttribute("id", "inp"+conID)
    AddPhoneFieldList.appendChild(inpA)  
    AddPhoneFieldList.appendChild(addButton) 
    AddPhoneFieldList.appendChild(cancelButton)        
    AddPhoneFieldList.setAttribute("id", "vlah")            
    
    return AddPhoneFieldList
}


function fillContacts(cont){
    
    let ul = document.createElement('ul')
    contactContent.innerHTML=""
        for(member in cont[0].contacts){
            let li = document.createElement('li')
            let text = document.createTextNode(`
            ${cont[0].contacts[member].firstname} ${cont[0].contacts[member].lastname}
            `)
            let linkEl1 = document.createElement('span')
            let linkEl2 = document.createElement('span')
            linkEl1.setAttribute('id', `${cont[0].contacts[member].contactID}editLink`)
            linkEl1.setAttribute('class', 'actionLink')
            linkEl2.setAttribute('id', `${cont[0].contacts[member].contactID}deleteLink`)
            linkEl2.setAttribute('class', 'actionLink')
            let link = document.createTextNode(`  edit  `)
            let deleteLink = document.createTextNode(`  delete  `)
            linkEl1.appendChild(link)
            linkEl2.appendChild(deleteLink)
            linkEl1.addEventListener('click', ()=>{
                alert("edit")
            })
            linkEl2.addEventListener('click', ()=>{
                alert("delete")
            })
            contactContent.appendChild(li)
            li.appendChild(text)
            li.appendChild(linkEl1)
            li.appendChild(linkEl2)
            var nUl = document.createElement('ul')
            let ULheader = document.createTextNode(`Phone Numbers `);
            nUl.appendChild(ULheader)

            //create add links for each category header(Phone Numbers, Email)
            
            //Phone Numbers
            let pnHeaderLinkBox = document.createElement("span");
            let pnHeaderLinkText = document.createTextNode("add");
            pnHeaderLinkBox.appendChild(pnHeaderLinkText);
            pnHeaderLinkBox.setAttribute("class", "actionLink")
            pnHeaderLinkBox.setAttribute("id", `${cont[0].contacts[member].contactID}pnHeaderEditLink`);
            pnHeaderLinkBox.addEventListener("click", ()=>{
                alert(this.id)
            })
            nUl.appendChild(pnHeaderLinkBox);
           

            //create phone number list for contact
            for(n in cont[0].contacts[member].phoneNumbers){                
                let nLi = document.createElement('li')
                let tNu = document.createTextNode(cont[0].contacts[member].phoneNumbers[n].number)
                nLi.appendChild(tNu)
                //create edit delete link for each number
                let pnEditLinkBox = document.createElement("span");
                let pnDeleteLinkBox = document.createElement("span");
                let pnEditLinkTT = document.createElement("span");
                let pnDeleteLinkTT = document.createElement("span");
                let pnEditLinkText = document.createTextNode("edit");
                let pnDeleteLinkText = document.createTextNode("del");
                let pnEditLinkTTtext = document.createTextNode("edit phone number");
                let pnDeleteLinkTTtext = document.createTextNode("delete phone number");
                pnEditLinkTT.appendChild(pnEditLinkTTtext);
                pnDeleteLinkTT.appendChild(pnDeleteLinkTTtext);
                pnEditLinkTT.setAttribute("class", "tooltip");
                pnDeleteLinkTT.setAttribute("class", "tooltip");
                pnEditLinkBox.appendChild(pnEditLinkText);
                pnEditLinkBox.appendChild(pnEditLinkTT);
                pnDeleteLinkBox.appendChild(pnDeleteLinkText);
                pnDeleteLinkBox.appendChild(pnDeleteLinkTT);
                
                pnEditLinkBox.setAttribute("class", "actionLink");
                //pnEditLinkBox.setAttribute("style", "background-image: url(../images/editPencil2.png")
                pnDeleteLinkBox.setAttribute("class", "actionLink");
                pnEditLinkBox.setAttribute("id","edit"+cont[0].contacts[member].contactID)
                pnEditLinkBox.addEventListener("click", (event)=>{
                    alert("edit company"+event.target.id+"'s number");
                });
                pnDeleteLinkBox.addEventListener("click", ()=>{
                    alert("delete number");
                });
                nLi.appendChild(pnEditLinkBox) 
                nLi.appendChild(pnDeleteLinkBox)
                nUl.appendChild(nLi) 
                                
            }
            li.appendChild(nUl)

            // create input field for the contact chosen on add page
            if(cont[0].contacts[member].contactID == conID && addCM == "phone"){
                nUl.appendChild(createInput(conID, addCM))
                $("#inp"+conID).focus()
                formatPN("#inp"+conID)
            }
            
            
            var eUl = document.createElement('ul')
            let ULEmailHeader = document.createTextNode(`Email `);
            eUl.appendChild(ULEmailHeader);
            //(cont[0].contacts[member].emails) ? eUl.appendChild(ULEmailHeader): "";
            //eUl.appendChild(ULEmailHeader)
            //eUl.appendChild(linkEl)
            for(n in cont[0].contacts[member].emails){
                //let nUl = document.createElement('ul')
                
                let nLi = document.createElement('li')
                let tNu = document.createTextNode(cont[0].contacts[member].emails[n].email)
                nLi.appendChild(tNu)
                eUl.appendChild(nLi)
                
                //li.appendChild(nUl)
            }
            
            
            
            li.appendChild(eUl)
            if(cont[0].contacts[member].contactID == conID && addCM == "email"){
                eUl.appendChild(createInput(conID, addCM))
                $("#inp"+conID).focus()
                //formatPN("#inp"+conID)
            }
            //contactContent.childNodes[0].innerHTML = cc
        }
        
        
}
function onlyUnique(value, index, self) { 
         return self.indexOf(value) === index;
}


    </script>
</body>
</html>